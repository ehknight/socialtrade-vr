<html>

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no,user-scalable=no,maximum-scale=1">
  <title>SocialTrade VR</title>
  <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
  <script src="https://rawgit.com/aframevr/aframe/master/dist/aframe.min.js"></script>
  <!-- TODO: Move all rawgits to cdn.rawgit !-->
  <script src="https://rawgit.com/bryik/aframe-bmfont-text-component/master/dist/aframe-bmfont-text-component.min.js"></script>
  <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v3.1.0/dist/aframe-extras.min.js"></script>
  <script src="https://rawgit.com/ngokevin/aframe-animation-component/master/dist/aframe-animation-component.min.js"></script>
  <script src="https://rawgit.com/bryik/aframe-vive-cursor-component/master/dist/aframe-vive-cursor-component.min.js"></script> 
  <link rel='shortcut icon' type='image/x-icon' href='/favicon.ico' />
  <script>
    AFRAME.registerComponent("move",{
    schema : {
      target : { type : "selector"},
      position : {type : "string"},
      level: {type: "string"}
    },
    init : function(){
      if (window.current_level != this.data.level) {
        this.el.addEventListener("click",function(){
                  console.log("activated animation")
                  console.log(this.data.level)
                  window.current_level = this.data.level
                  var animation = document.createElement("a-animation");
                  animation.setAttribute("attribute","position");
                  animation.setAttribute("to",this.data.position);
                  animation.setAttribute("dur","1000");
                  animation.setAttribute("repeat","0");
                  this.data.target.appendChild(animation);
        }.bind(this));
      } else {
        console.log("same animation level")
      }
    }
    });
  </script>
</head>

<body>
  <a-scene debug id="scene">
    <a-assets id="aframe-assets">
      <img id="sky" src="/static/sky.png">
      <img id="ground" src="/static/sand.jpg">
      <img id="back-button" src="/static/back-button.jpg">
    </a-assets>
    <a-entity id="vive-controls-switch">\
        <a-entity vive-controls="hand: left"></a-entity>\
        <a-entity vive-controls="hand: right" vive-cursor></a-entity>\
      </a-entity>
    <script>
      if (!window.current_level) {
        window.current_level = "0"
      }
      // window.gear_html = '<a-entity id="gear-controls-switch">\
      //     <a-entity id="user" position="0 2.2 4">\
      //       <a-entity id="cursor" camera universal-controls position="0 2 0">\
      //         <a-entity position="0 0 -3" scale="0.3 0.3 0.3" geometry="primitive: ring; radiusOuter: 0.30;\
      //               radiusInner: 0.20;" material="color: #3f43ad; shader: flat" cursor="maxDistance: 100;">\
      //           <a-animation begin="click" easing="ease-in" attribute="scale" fill="backwards" from="0.1 0.1 0.1" to="0.5 0.5 0.5" dur="150"></a-animation>\
      //           <a-animation begin="fusing" easing="ease-in" attribute="scale" fill="forwards" from="0.5 0.5 0.t" to="0.1 0.1 0.1" dur="1500"></a-animation>\
      //         </a-entity>\
      //       </a-entity>\
      //     </a-entity>\
      //     </a-entity>'
      // window.vive_html = '<a-entity id="vive-controls-switch">\
      //   <a-entity vive-controls="hand: left"></a-entity>\
      //   <a-entity vive-controls="hand: right"></a-entity>\
      //   </a-entity>'
      // if (!AFRAME.utils.device.checkHeadsetConnected() || AFRAME.utils.device.isMobile()) {
      //   console.log("loading gear controls")
      //   $("#scene").append(window.gear_html) // either desktop or mobile
      //   console.log("finished loading gear controls")
      // }
      // if (!AFRAME.utils.device.isMobile() && AFRAME.utils.device.checkHeadsetConnected()) {
      //   $("#scene").append(window.vive_html) // if oculus rift or vive
      // }
    </script>
    <a-sky src="#sky" position="0 -200 0"></a-sky>
    <a-grid></a-grid>

    <a-light type="ambient" color="#ccc"></a-light>
    <a-light color="#ddf" distance="100" intensity="0.4" type="point"></a-light>
    <a-light color="#ddf" position="3 10 -10" distance="50" intensity="0.4" type="point"></a-light>
    <a-sphere id="backbutton" src="#back-button" radius="1" scale="0.5 0.5 0.5" position=" 0 0.47 0" rotation="-79.6 -8.02 -13.7"></a-sphere>
    <script>
      $(document).ready(function(){
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        window.socket = socket;
        var numbers_received = [];
        $("#backbutton").on('click', function() {socket.emit('go_back')})
        socket.on('check_vive_connected', function() {
          if (!AFRAME.utils.device.isMobile() && AFRAME.utils.device.checkHeadsetConnected()) {
            try {
              $("#gear-controls-switch").remove()
            } catch(err) {}
            if($("#vive-controls-switch").length == 0) {
              //it doesn't exist
            } else {
              $("#scene").append(window.vive_html)
        }}})
        socket.on('receive_views', function(msg) {
          console.log("preparing to receive views!")
          try{
            $("#currentview").remove()
          } catch(err) {
            console.log(err)
          }
          console.log(msg);
          try {
            var animation = document.createElement("a-animation");
            animation.setAttribute("attribute","position");
            animation.setAttribute("to","0 -1 0");
            animation.setAttribute("dur","2000");
            animation.setAttribute("repeat","0");
            animation.setAttribute("animationend",$("#view_box").remove())
            $("#view_box").append(animation)
          } catch(err) {
            console.log(err)
          }
          total_html = ""
          for (var i = 0; i<msg.length; i++) {
            var view = msg[i]
            var button_asset_id = view.id+'img_asset'
            $("#aframe-assets").append("<img id='"+button_asset_id+"' src='"+view.image+"' crossorigin='anonymous'>")
            var curved_image_html="<a-curvedimage id='"+view.id+"img' src='#"+button_asset_id+"' position='"+view.image_pos+"' height='6' radius='10' theta-length='50' rotation='"+view.theta+"' crossorigin=anonymous> </a-curvedimage>"
            var button_html = "<a-entity id='"+view.id+"button' geometry='primitive:box' rotation='"+view.button_rot+"' material='color:white' scale='1 2 7' position='"+view.button_pos+"' move='target:#user;position:0 "+view.button_height+" 0;level:"+view.level+"'>"
            var text_html = "<a-entity bmfont-text='text: "+view.name+"; fnt:/futura.fnt; fntImage:/futura.png; width:800; lineHeight:60; align:center; color:black;' scale='0.21 0.72 1.00' position='-0.51 "+view.text_pos_height+" -0.42' rotation='0 270 0'> </a-entity>"
            var closing_button_html = "</a-entity>"
            var on_click_js = "\<script id='"+view.id+"script'\>"+
                              "document.querySelector('"+view.hash_id+"button').addEventListener('click', function(){"+
                              "if ("+view.is_stack+") {" +
                              "console.log('i have been clicked!');"+
                              "window.socket.emit\('send_view', \{data\: '"+view.id+"'\}\);"+
                              "return;\}\}\);"+
                              "\<\/script\>"
            var complete_html = curved_image_html+button_html+text_html+closing_button_html+on_click_js
            total_html = total_html+complete_html
          }
          $("#scene").append("<a-entity id='view_box' visible='true'><a-animation attribute='position' from='0 20 0' to='0 0 0' dur='2000'></a-animation>"+total_html+"</a-entity>")

        });
      });
    </script> 
    <div class="added"></div>
    </a-scene>
  <body>

</html>
